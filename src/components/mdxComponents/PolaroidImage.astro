---
// src/components/PolaroidImage.astro
interface Props {
  src: string;
  alt: string;
  caption?: string;
  width?: string;
  rotate?: number | 'random';
  className?: string;
}

const { 
  src, 
  alt, 
  caption, 
  width = '100%', 
  rotate = 0,
  className = '' 
} = Astro.props;

// Generate rotation value
let rotation = 0;
if (rotate === 'random') {
  rotation = (Math.random() - 0.5) * 6; // Random between -3 and 3 degrees
} else if (typeof rotate === 'number') {
  rotation = rotate;
}

// Generate unique ID for this instance
const uniqueId = `polaroid-${Math.random().toString(36).substr(2, 9)}`;
---

<div 
  class={`transition-transform duration-300 hover:rotate-0 my-5 mx-auto ${className}`}
  style={`max-width: ${width}; transform: rotate(${rotation}deg);`}
>
  <div class="bg-white p-3 shadow-2xl hover:shadow-3xl transition-shadow duration-300 mx-auto cursor-pointer" data-polaroid-trigger={uniqueId}>
    <img
      src={src}
      alt={alt}
      loading="lazy"
      class="w-full h-auto mx-auto"
    />
    {caption && (
      <div class="mt-3 text-center px-2">
        <p class="text-syoro !font-handwriting !text-xl sm:text-sm">
          {caption}
        </p>
      </div>
    )}
  </div>
</div>

<!-- Lightbox Overlay -->
<div 
  id={uniqueId}
  class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 backdrop-blur-sm"
  data-polaroid-lightbox
>
  <button 
    class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors z-10"
    aria-label="Close"
    data-polaroid-close
  >
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
  
  <div class="max-w-7xl max-h-[90vh] flex flex-col items-center">
    <img
      src={src}
      alt={alt}
      class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl"
    />
    {caption && (
      <p class="text-white text-lg mt-4 text-center max-w-2xl">
        {caption}
      </p>
    )}
  </div>
</div>

<script define:vars={{ uniqueId }}>
  // Wait for DOM to be ready
  if (typeof window !== 'undefined') {
    const trigger = document.querySelector(`[data-polaroid-trigger="${uniqueId}"]`);
    const lightbox = document.getElementById(uniqueId);
    const closeBtn = lightbox?.querySelector('[data-polaroid-close]');

    // Open lightbox
    trigger?.addEventListener('click', () => {
      lightbox?.classList.remove('hidden');
      lightbox?.classList.add('flex');
      document.body.style.overflow = 'hidden';
    });

    // Close lightbox - close button
    closeBtn?.addEventListener('click', () => {
      lightbox?.classList.add('hidden');
      lightbox?.classList.remove('flex');
      document.body.style.overflow = '';
    });

    // Close lightbox - click outside
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = '';
      }
    });

    // Close lightbox - escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox?.classList.contains('flex')) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
        document.body.style.overflow = '';
      }
    });
  }
</script>

<!-- Usage Example
<PolaroidImage
  src="path/to/image.jpg"
  alt="Description of the image"
  caption="Optional caption"
  rotate="random"
/>
-->